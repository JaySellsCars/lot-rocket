// /public/app.js  (REPLACE ENTIRE FILE)
// FULL RESTORE (SAFE) â€” boots UI + wires core buttons without crashing
(() => {
  const V = "10001";
  console.log("ðŸ§¨ APPJS BOOT OK â€” v" + V);

  const DOC = document;
  const $ = (id) => DOC.getElementById(id);
  const q = (sel, root = DOC) => root.querySelector(sel);
  const on = (el, ev, fn, opts) => el && el.addEventListener(ev, fn, opts);

  // ---------- STORE ----------
  const STORE = (window.STORE = window.STORE || {});
  const asArr = (v) => (Array.isArray(v) ? v : []);
  STORE.lastBoostPhotos = asArr(STORE.lastBoostPhotos);
  STORE.holdingZonePhotos = asArr(STORE.holdingZonePhotos);
  STORE.socialReadyPhotos = asArr(STORE.socialReadyPhotos);

  // ---------- SAFE HELPERS ----------
  const safe = (name, fn, ...args) => {
    try {
      if (typeof fn === "function") return fn(...args);
      return;
    } catch (e) {
      console.error("âŒ", name, e);
    }
  };

  const show = (el) => { if (el) { el.classList.remove("hidden"); el.setAttribute("aria-hidden", "false"); } };
  const hide = (el) => { if (el) { el.classList.add("hidden"); el.setAttribute("aria-hidden", "true"); } };

  function wireCloseButtons() {
    DOC.querySelectorAll("[data-close]").forEach((btn) => {
      on(btn, "click", () => hide(btn.closest(".side-modal,.modal,[role='dialog']")));
    });
  }

  function wireDropZone() {
    const dz = $("photoDropZone");
    const inp = $("photoFileInput");
    if (!dz || !inp) return;

    on(dz, "click", () => inp.click());

    const handleFiles = (files) => {
      const arr = Array.from(files || []).filter(Boolean);
      if (!arr.length) return;
      // just show thumbnails for now (no crash)
      const grid = $("creativeThumbGrid");
      if (!grid) return;
      arr.forEach((f) => {
        const url = URL.createObjectURL(f);
        const wrap = DOC.createElement("div");
        wrap.className = "thumb";
        wrap.innerHTML = `<img src="${url}" style="max-width:100%;border-radius:10px" />`;
        grid.appendChild(wrap);
        STORE.holdingZonePhotos.push(url);
      });
    };

    on(inp, "change", () => handleFiles(inp.files));
    on(dz, "dragover", (e) => { e.preventDefault(); dz.classList.add("drag"); });
    on(dz, "dragleave", () => dz.classList.remove("drag"));
    on(dz, "drop", (e) => {
      e.preventDefault();
      dz.classList.remove("drag");
      handleFiles(e.dataTransfer && e.dataTransfer.files);
    });
  }

  function wireBasicButtons() {
    on($("boostBtn"), "click", () => console.log("ðŸŸ¢ Boost clicked"));
    on($("newPostBtn"), "click", () => console.log("ðŸŸ¢ New Post"));
    on($("copyPostBtn"), "click", () => console.log("ðŸŸ¢ Copy Post"));
    on($("newTextBtn"), "click", () => console.log("ðŸŸ¢ New Text"));
    on($("copyTextBtn"), "click", () => console.log("ðŸŸ¢ Copy Text"));

    on($("autoEnhanceBtn"), "click", () => console.log("ðŸŸ¢ Auto Enhance"));
    on($("resetEditsBtn"), "click", () => console.log("ðŸŸ¢ Reset Edits"));

    on($("sendToDesignStudio"), "click", () => console.log("ðŸŸ¢ Send to Design Studio"));
    on($("sendToSocialReady"), "click", () => console.log("ðŸŸ¢ Send to Social Ready"));

    on($("incomeCalcBtn"), "click", () => show($("incomeModal")));
  }

  function finalInit() {
    wireCloseButtons();
    wireDropZone();
    wireBasicButtons();

    // call legacy functions if present
    safe("wireAiModals", window.wireAiModals);
    safe("wireSideTools", window.wireSideTools);
    safe("wireCalculatorPad", window.wireCalculatorPad);
    safe("wireIncomeCalcDirect", window.wireIncomeCalcDirect);

    safe("renderCreativeThumbs", window.renderCreativeThumbs);
    safe("renderSocialStrip", window.renderSocialStrip);

    console.log("âœ… FINAL INIT COMPLETE");
  }

  DOC.addEventListener("DOMContentLoaded", () => {
    if (window.__LOTROCKET_BOOTED__) return;
    window.__LOTROCKET_BOOTED__ = true;
    console.log("âœ… DOM READY");
    finalInit();
  });
})();
